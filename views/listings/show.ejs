<% layout("layouts/boilerplate") %>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN || '' %>";
  const coordinates = [0, 0]; // Default coordinates
</script>

<div class="container mt-4">
  <div class="row">
    <!-- Left Column - Listing Details -->
    <div class="col-lg-8">
      <div class="card listing-card">
        <img
          src="<%= listing.image.url %>"
          class="card-img-top show-img"
          alt="<%= listing.title %>"
        />
        <div class="card-body">
          <h2 class="card-title"><%= listing.title %></h2>
          <p class="text-muted">
            <i class="fas fa-map-marker-alt"></i>
            <%= listing.location %>, <%= listing.country %>
          </p>
          <p class="card-text"><%= listing.description %></p>
        </div>
      </div>
    </div>

    <!-- Right Column - Booking Card -->
    <div class="col-lg-4">
      <div class="card booking-card">
        <div class="card-body">
          <h5 class="card-title">
            <span class="price">â‚¹<%= listing.price %></span>
            <span class="text-muted">/night</span>
          </h5>

          <!-- Booking Form -->
          <form class="mt-4">
            <div class="mb-3">
              <label class="form-label">Check-in</label>
              <input type="date" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Check-out</label>
              <input type="date" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Guests</label>
              <select class="form-select">
                <% for(let i = 1; i <= (listing.capacity?.total || 2); i++) { %>
                <option value="<%= i %>">
                  <%= i %> guest<%= i > 1 ? 's' : '' %>
                </option>
                <% } %>
              </select>
            </div>
            <button class="btn btn-success w-100">Reserve Now</button>
          </form>

          <!-- Property Details -->
          <div class="property-details mt-4">
            <h6>Property Details:</h6>
            <ul class="list-unstyled">
              <li>
                <i class="fas fa-bed"></i> <%= listing.rooms.bedrooms %>
                Bedrooms
              </li>
              <li>
                <i class="fas fa-bath"></i> <%= listing.rooms.bathrooms %>
                Bathrooms
              </li>
              <li>
                <i class="fas fa-users"></i> Up to <%= listing.capacity.total %>
                guests
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .show-img {
    height: 400px;
    object-fit: cover;
  }

  .listing-card {
    border: none;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
  }

  .booking-card {
    border: none;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 20px;
  }

  .price {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2ecc71;
  }

  .property-details li {
    margin-bottom: 10px;
    color: #666;
  }

  .property-details i {
    color: #2ecc71;
    margin-right: 10px;
    width: 20px;
  }

  .btn-success {
    background: #2ecc71;
    border: none;
    padding: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .show-img {
      height: 300px;
    }

    .booking-card {
      position: static;
      margin-top: 20px;
    }
  }
</style>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<link
  href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css"
  rel="stylesheet"
/>
<script>
  mapboxgl.accessToken = "<%= process.env.MAP_TOKEN %>";
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v11",
    center: coordinates,
    zoom: 12,
  });

  new mapboxgl.Marker()
    .setLngLat(coordinates)
    .setPopup(
      new mapboxgl.Popup({ offset: 25 }).setHTML(
        `<h6><%= listing.title %></h6><p><%= listing.location %></p>`
      )
    )
    .addTo(map);
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  document
    .getElementById("payButton")
    .addEventListener("click", async function () {
      try {
        // Get payment details from server
        const response = await fetch(`/listings/<%= listing.id %>/pay`, {
          method: "POST",
        });
        const data = await response.json();

        // Configure Razorpay options
        const options = {
          key: data.keyId,
          amount: data.amount,
          currency: data.currency,
          name: "WanderLust",
          description: `Booking for ${data.listingTitle}`,
          order_id: data.orderId,
          handler: async function (response) {
            try {
              // Verify payment
              const verifyResponse = await fetch("/verify-payment", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature,
                }),
              });

              const verifyData = await verifyResponse.json();

              if (verifyData.success) {
                alert("Payment successful! Booking confirmed.");
                window.location.href = "/listings";
              } else {
                alert("Payment verification failed. Please try again.");
              }
            } catch (error) {
              alert("Payment verification failed. Please try again.");
            }
          },
          prefill: {
            name: "",
            email: "",
            contact: "",
          },
          theme: {
            color: "#2ecc71",
          },
        };

        // Initialize Razorpay
        const rzp = new Razorpay(options);
        rzp.open();
      } catch (error) {
        alert("Failed to initialize payment. Please try again.");
      }
    });
</script>
