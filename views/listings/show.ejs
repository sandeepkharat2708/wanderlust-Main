<% layout("layouts/boilerplate") %>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN || '' %>";
  const coordinates = [0, 0]; // Default coordinates
</script>

<div class="container mt-4">
  <div class="row">
    <!-- Left Column - Listing Details -->
    <div class="col-lg-8">
      <div class="card listing-card">
        <!-- Image Section -->
        <% if (listing.image && listing.image.url) { %>
        <img
          src="<%= listing.image.url %>"
          class="card-img-top show-img"
          alt="<%= listing.title %>"
        />
        <% } %>

        <div class="card-body">
          <!-- Title and Location -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h2 class="card-title mb-1"><%= listing.title %></h2>
              <p class="text-muted mb-0">
                <i class="fas fa-map-marker-alt"></i>
                <%= listing.location %>, <%= listing.country %>
              </p>
            </div>
            <span class="category-badge"><%= listing.category %></span>
          </div>

          <!-- Description -->
          <div class="mb-4">
            <h5>About this place</h5>
            <p class="card-text"><%= listing.description %></p>
          </div>

          <!-- Features -->
          <div class="features mb-4">
            <h5>What this place offers</h5>
            <div class="row g-3 mt-1">
              <% if (listing.rooms?.bedrooms) { %>
              <div class="col-6">
                <i class="fas fa-bed text-success"></i>
                <%= listing.rooms.bedrooms %> Bedrooms
              </div>
              <% } %> <% if (listing.rooms?.bathrooms) { %>
              <div class="col-6">
                <i class="fas fa-bath text-success"></i>
                <%= listing.rooms.bathrooms %> Bathrooms
              </div>
              <% } %> <% if (listing.capacity?.total) { %>
              <div class="col-6">
                <i class="fas fa-users text-success"></i>
                Up to <%= listing.capacity.total %> guests
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Booking Card -->
    <div class="col-lg-4">
      <div class="card booking-card">
        <div class="card-body">
          <!-- Price -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <span class="price">₹<%= listing.price %></span>
              <span class="text-muted">/night</span>
            </div>
          </div>

          <!-- Booking Form -->
          <form class="booking-form">
            <div class="mb-3">
              <label class="form-label">Check-in</label>
              <input type="date" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Check-out</label>
              <input type="date" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Guests</label>
              <select class="form-select">
                <% for(let i = 1; i <= (listing.capacity?.total || 2); i++) { %>
                <option value="<%= i %>">
                  <%= i %> guest<%= i > 1 ? 's' : '' %>
                </option>
                <% } %>
              </select>
            </div>
            <button type="submit" class="btn btn-success w-100 mb-3">
              Reserve Now
            </button>
          </form>

          <!-- Price Details -->
          <div class="price-details border-top pt-3">
            <div class="d-flex justify-content-between mb-2">
              <span>₹<%= listing.price %> × 1 night</span>
              <span>₹<%= listing.price %></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Service fee</span>
              <span>₹<%= Math.round(listing.price * 0.1) %></span>
            </div>
            <div
              class="d-flex justify-content-between fw-bold border-top pt-2 mt-2"
            >
              <span>Total</span>
              <span>₹<%= Math.round(listing.price * 1.1) %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="mt-4">
    <a href="/listings" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to all listings
    </a>
  </div>
</div>

<style>
  .show-img {
    height: 400px;
    object-fit: cover;
    border-radius: 15px 15px 0 0;
  }

  .listing-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .booking-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 20px;
  }

  .price {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2ecc71;
  }

  .category-badge {
    background: rgba(46, 204, 113, 0.9);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
  }

  .features i {
    margin-right: 8px;
    width: 20px;
  }

  .btn-success {
    background: #2ecc71;
    border: none;
    padding: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .show-img {
      height: 300px;
    }

    .booking-card {
      position: static;
      margin-top: 20px;
    }
  }
</style>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<link
  href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css"
  rel="stylesheet"
/>
<script>
  mapboxgl.accessToken = "<%= process.env.MAP_TOKEN %>";
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v11",
    center: coordinates,
    zoom: 12,
  });

  new mapboxgl.Marker()
    .setLngLat(coordinates)
    .setPopup(
      new mapboxgl.Popup({ offset: 25 }).setHTML(
        `<h6><%= listing.title %></h6><p><%= listing.location %></p>`
      )
    )
    .addTo(map);
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  document
    .getElementById("payButton")
    .addEventListener("click", async function () {
      try {
        // Get payment details from server
        const response = await fetch(`/listings/<%= listing.id %>/pay`, {
          method: "POST",
        });
        const data = await response.json();

        // Configure Razorpay options
        const options = {
          key: data.keyId,
          amount: data.amount,
          currency: data.currency,
          name: "WanderLust",
          description: `Booking for ${data.listingTitle}`,
          order_id: data.orderId,
          handler: async function (response) {
            try {
              // Verify payment
              const verifyResponse = await fetch("/verify-payment", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature,
                }),
              });

              const verifyData = await verifyResponse.json();

              if (verifyData.success) {
                alert("Payment successful! Booking confirmed.");
                window.location.href = "/listings";
              } else {
                alert("Payment verification failed. Please try again.");
              }
            } catch (error) {
              alert("Payment verification failed. Please try again.");
            }
          },
          prefill: {
            name: "",
            email: "",
            contact: "",
          },
          theme: {
            color: "#2ecc71",
          },
        };

        // Initialize Razorpay
        const rzp = new Razorpay(options);
        rzp.open();
      } catch (error) {
        alert("Failed to initialize payment. Please try again.");
      }
    });
</script>
