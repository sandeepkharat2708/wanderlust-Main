</script>

<div class="container mt-4">
  <div class="row">
    <!-- Left Column - Listing Details -->
    <div class="col-lg-8">
      <div class="card listing-card">
        <!-- Image Section -->
        <% if (listing.image && listing.image.url) { %>
        <img
          src="<%= listing.image.url %>"
          class="card-img-top show-img"
          alt="<%= listing.title %>"
        />
        <% } %>

        <div class="card-body">
          <!-- Title and Location -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h2 class="card-title mb-1"><%= listing.title %></h2>
              <p class="text-muted mb-0">
                <i class="fas fa-map-marker-alt"></i>
                <%= listing.location %>, <%= listing.country %>
              </p>
            </div>
            <span class="category-badge"><%= listing.category %></span>
          </div>

          <!-- Description -->
          <div class="mb-4">
            <h5>About this place</h5>
            <p class="card-text"><%= listing.description %></p>
          </div>

          <!-- Features -->
          <div class="features mb-4">
            <h5>What this place offers</h5>
            <div class="row g-3 mt-1">
              <!-- Rooms -->
              <div class="col-6">
                <i class="fas fa-bed text-success"></i>
                <%= listing.rooms %> Rooms
              </div>

              <!-- Capacity -->
              <div class="col-6">
                <i class="fas fa-users text-success"></i>
                Up to <%= listing.capacity %> guests
              </div>

              <!-- Phone -->
              <div class="col-6">
                <i class="fas fa-phone text-success"></i>
                <%= listing.phone %>
              </div>

              <!-- Email if available -->
              <% if(listing.email) { %>
              <div class="col-6">
                <i class="fas fa-envelope text-success"></i>
                <%= listing.email %>
              </div>
              <% } %>

              <!-- Price -->
              <div class="col-6">
                <i class="fas fa-rupee-sign text-success"></i>
                <%= listing.price %> per night
              </div>

              <!-- Category -->
              <div class="col-6">
                <i class="fas fa-tag text-success"></i>
                <%= listing.category %>
              </div>
            </div>
          </div>

          <!-- Add this after the listing details and before the map -->
          <% if (currentUser && (currentUser.isAdmin || String(currentUser._id) === String(listing.owner))) { %>
            <div class="admin-controls mb-3">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning me-2">
                <i class="fas fa-edit"></i> Edit Listing
              </a>
              <form class="d-inline" action="/listings/<%= listing._id %>?_method=DELETE" method="POST">
                <button class="btn btn-danger">
                  <i class="fas fa-trash"></i> Delete Listing
                </button>
              </form>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Right Column - Map Card -->
    <div class="col-lg-4">
      <div class="card map-card">
        <div class="card-body p-0">
          <!-- Map Container -->
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="mt-4">
    <a href="/listings" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to all listings
    </a>
  </div>
</div>

<style>
  .show-img {
    height: 400px;
    object-fit: cover;
    border-radius: 15px 15px 0 0;
  }

  .listing-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .map-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 20px;
    overflow: hidden;
  }

  .price {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2ecc71;
  }

  .category-badge {
    background: rgba(46, 204, 113, 0.9);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
  }

  .features i {
    margin-right: 8px;
    width: 20px;
  }

  .btn-success {
    background: #2ecc71;
    border: none;
    padding: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .show-img {
      height: 300px;
    }

    .map-card {
      position: static;
      margin-top: 20px;
    }

    #map {
      height: 300px;
    }
  }

  .mapboxgl-popup-content {
    padding: 15px;
    border-radius: 10px;
  }

  .mapboxgl-popup-content h6 {
    margin: 0 0 5px 0;
    color: #2d3436;
  }

  .mapboxgl-popup-content p {
    margin: 0;
    color: #636e72;
  }

  #map {
    width: 100%;
    height: 500px;
    border-radius: 15px;
  }

  .admin-controls {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
  }

  .admin-controls .btn {
    padding: 8px 16px;
  }

  .admin-controls .btn i {
    margin-right: 5px;
  }

  .features .col-6 {
    padding: 10px;
    font-size: 0.95rem;
    color: #2d3436;
  }

  .features .col-6:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
  }
</style>

<script>
  // Check if listing has geometry coordinates, otherwise use default
  const defaultCoordinates = [77.2090, 28.6139]; // Default to Delhi coordinates
  const listingCoordinates = '<%= listing.geometry?.coordinates %>' || null;
  const coordinates = listingCoordinates ? listingCoordinates.split(',').map(Number) : defaultCoordinates;

  // Initialize the map
  mapboxgl.accessToken = '<%= process.env.MAP_TOKEN %>';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: coordinates,
    zoom: 9
  });

  // Add marker
  const marker = new mapboxgl.Marker({color: '#ff0000'})
    .setLngLat(coordinates)
    .addTo(map);

  // Add navigation controls
  map.addControl(new mapboxgl.NavigationControl());

  // Add popup
  new mapboxgl.Popup({offset: 25})
    .setLngLat(coordinates)
    .setHTML(`
      <h6><%= listing.title %></h6>
      <p><%= listing.location %>, <%= listing.country %></p>
    `)
    .addTo(map);

  // Ensure the map resizes properly
  map.on('load', function() {
    map.resize();
  });
</script>

<% layout("layouts/boilerplate") %>
