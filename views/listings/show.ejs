<%- layout("/layouts/boilerplate.ejs") -%>

<script>
    const mapToken = "<%= process.env.MAP_TOKEN %>";
    const coordinates = <%- JSON.stringify(listing.geometry.coordinates) %>;
</script>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="text-center text-primary fw-bold"><%= listing.title %></h2>
            <div class="card listing-card shadow-lg border-0 rounded-4 overflow-hidden">
                <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="Listing Image" style="height: 400px; object-fit: cover;">
                <div class="card-body text-center">
                    <p class="card-text text-muted">Owned by <i class="fw-bold">@<%= listing.owner.username %></i></p>
                    <p class="card-text lead"><%= listing.description %></p>
                    <p class="fs-4 fw-bold text-success">&#8377;<%= listing.price.toLocaleString("en-IN") %> / Night</p>
                    <p class="text-secondary"><i class="bi bi-geo-alt"></i> <%= listing.location %>, <%= listing.country %></p>
                </div>
            </div>
            <div class="mt-3 text-center">
                <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
                    <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning me-2 px-4">Edit</a>
                    <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
                        <button class="btn btn-danger px-4" onclick="return confirm('Are you sure?')">Delete</button>
                    </form>
                <% } %>
            </div>
        </div>
    </div>
    
    <% if(currUser) { %>
    <div class="row justify-content-center mt-5">
        <div class="col-md-8">
            <h4 class="text-center">Leave a Review</h4>
            <form action="/listings/<%= listing._id %>/reviews" method="post" class="p-4 shadow rounded bg-light">
                <div class="mb-3">
                    <label for="rating" class="form-label">Rating</label>
                    <select name="review[rating]" class="form-select">
                        <option value="5">⭐⭐⭐⭐⭐ - Amazing</option>
                        <option value="4">⭐⭐⭐⭐ - Very Good</option>
                        <option value="3">⭐⭐⭐ - Average</option>
                        <option value="2">⭐⭐ - Not Good</option>
                        <option value="1">⭐ - Terrible</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment</label>
                    <textarea name="review[comment]" class="form-control" rows="4" required></textarea>
                </div>
                <div class="text-center">
                    <button class="btn btn-outline-dark w-100">Submit Review</button>
                </div>
            </form>
        </div>
    </div>
    <% } %>
    
    <% if(listing.reviews.length > 0) { %>
    <div class="row justify-content-center mt-5">
        <div class="col-lg-10">
            <h4 class="text-center">All Reviews</h4>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <% for(review of listing.reviews) { %>
                <div class="col">
                    <div class="card shadow-lg border-0 h-100 p-3 rounded-4 hover-effect">
                        <div class="card-body">
                            <h5 class="fw-bold">@<%= review.author.username %></h5>
                            <p class="text-warning">⭐ Rating: <%= review.rating %></p>
                            <p><%= review.comment %></p>
                        </div>
                        <% if(currUser && review.author._id.equals(currUser._id)) { %>
                            <div class="card-footer bg-transparent border-0 text-center">
                                <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="post" class="d-inline">
                                    <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this review?')">Delete</button>
                                </form>
                            </div>
                        <% } %>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
    </div>
    <% } %>
    
    <div class="row justify-content-center mt-5">
        <div class="col-lg-8 text-center">
            <h3 class="text-primary fw-bold border-bottom pb-2 mb-3">Where You'll Be</h3>
            <div id="map" class="rounded border border-primary shadow-lg" style="height: 400px;"></div>
        </div>
    </div>
</div>

<style>
    .hover-effect:hover {
        transform: scale(1.05);
        transition: 0.3s ease-in-out;
    }
    #map {
        margin: auto;
        width: 100%;
    }
</style>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet" />
<script>
    mapboxgl.accessToken = "<%= process.env.MAP_TOKEN %>";
    const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v11",
        center: coordinates,
        zoom: 12
    });

    new mapboxgl.Marker()
        .setLngLat(coordinates)
        .setPopup(
            new mapboxgl.Popup({ offset: 25 })
                .setHTML(`<h6><%= listing.title %></h6><p><%= listing.location %></p>`)
        )
        .addTo(map);
</script>
