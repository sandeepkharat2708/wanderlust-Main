</script>

<div class="container mt-4">
  <div class="row">
    <!-- Left Column - Listing Details -->
    <div class="col-lg-8">
      <div class="card listing-card">
        <!-- Image Section -->
        <% if (listing.image && listing.image.url) { %>
        <img
          src="<%= listing.image.url %>"
          class="card-img-top show-img"
          alt="<%= listing.title %>"
        />
        <% } %>

        <div class="card-body">
          <!-- Title and Location -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h2 class="card-title mb-1"><%= listing.title %></h2>
              <p class="text-muted mb-0">
                <i class="fas fa-map-marker-alt"></i>
                <%= listing.location %>, <%= listing.country %>
              </p>
            </div>
            <span class="category-badge"><%= listing.category %></span>
          </div>

          <!-- Description -->
          <div class="mb-4">
            <h5>About this place</h5>
            <p class="card-text"><%= listing.description %></p>
          </div>

          <!-- Features -->
          <div class="features mb-4">
            <h5>What this place offers</h5>
            <div class="row g-3 mt-1">
              <!-- Rooms -->
              <div class="col-6">
                <i class="fas fa-bed text-success"></i>
                <%= listing.rooms %> Rooms
              </div>

              <!-- Capacity -->
              <div class="col-6">
                <i class="fas fa-users text-success"></i>
                Up to <%= listing.capacity %> guests
              </div>

              <!-- Phone -->
              <div class="col-6">
                <i class="fas fa-phone text-success"></i>
                <%= listing.phone %>
              </div>

              <!-- Email if available -->
              <% if(listing.email) { %>
              <div class="col-6">
                <i class="fas fa-envelope text-success"></i>
                <%= listing.email %>
              </div>
              <% } %>

              <!-- Price -->
              <div class="col-6">
                <i class="fas fa-rupee-sign text-success"></i>
                <%= listing.price %> per night
              </div>

              <!-- Category -->
              <div class="col-6">
                <i class="fas fa-tag text-success"></i>
                <%= listing.category %>
              </div>
            </div>
          </div>

          <!-- Add this temporarily to debug -->
          <% if(currentUser) { %>
            <div style="display: none">
              Current User ID: <%= currentUser._id %><br>
              Listing Owner ID: <%= listing.owner._id %><br>
              Are Equal: <%= listing.owner._id.equals(currentUser._id) %>
            </div>
          <% } %>

          <!-- Owner Controls - Only visible to owner or admin -->
          <% if(currentUser && (currentUser.isAdmin || listing.owner._id.equals(currentUser._id))) { %>
            <div class="admin-controls mb-3">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning me-2">
                <i class="fas fa-edit"></i> Edit Listing
              </a>
              <form class="d-inline" action="/listings/<%= listing._id %>?_method=DELETE" method="POST">
                <button class="btn btn-danger" onclick="return confirm('Are you sure?')">
                  <i class="fas fa-trash"></i> Delete Listing
                </button>
              </form>
            </div>
          <% } else if(currentUser) { %>
            <!-- User Controls - Only visible to logged-in non-owners -->
            <% if(currentUser && !listing.owner._id.equals(currentUser._id)) { %>
              <div class="booking-section mt-3">
                <% if(currentUser) { %>
                  <% if(!listing.owner._id.equals(currentUser._id)) { %>
                    <form id="bookingForm">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">Check-in</label>
                          <input type="date" class="form-control" id="checkIn" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Check-out</label>
                          <input type="date" class="form-control" id="checkOut" required>
                        </div>
                        <div class="col-12">
                          <label class="form-label">Number of Guests</label>
                          <div class="input-group">
                            <input 
                              type="number" 
                              class="form-control" 
                              id="guests" 
                              min="1" 
                              max="<%= listing.capacity %>" 
                              value="1" 
                              required
                            >
                            <span class="input-group-text">/ <%= listing.capacity %> max</span>
                          </div>
                          <div class="form-text">Maximum capacity: <%= listing.capacity %> guests</div>
                        </div>

                        <!-- Price Breakdown Card -->
                        <div class="col-12">
                          <div class="card bg-light">
                            <div class="card-body">
                              <h5>Price Details</h5>
                              <div id="priceBreakdown"></div>
                            </div>
                          </div>
                        </div>

                        <div class="col-12">
                          <button 
                            type="submit" 
                            class="btn btn-success w-100 btn-lg"
                            id="bookNowBtn"
                            disabled
                          >
                            Book Now
                          </button>
                        </div>
                      </div>
                    </form>
                  <% } %>
                <% } %>
              </div>
            <% } else if(!currentUser) { %>
              <a href="/login" class="btn btn-outline-success btn-lg w-100 mb-3">
                <i class="fas fa-sign-in-alt me-2"></i>Login to Book
              </a>
            <% } %>
          <% } else { %>
            <!-- Guest Controls - Visible to non-logged-in users -->
            <div class="guest-controls mb-3">
              <a href="/login" class="btn btn-outline-success btn-lg w-100">
                <i class="fas fa-sign-in-alt"></i> Login to Book
              </a>
            </div>
          <% } %>

          <!-- Reviews Section -->
          <div class="reviews-section mt-5">
            <h3 class="mb-4">Reviews</h3>

            <!-- Add Review Form -->
            <% if(currentUser && !listing.owner._id.equals(currentUser._id)) { %>
              <div class="card mb-4">
                <div class="card-body">
                  <h5 class="card-title mb-3">Add Your Review</h5>
                  <form action="/listings/<%= listing._id %>/reviews" method="POST">
                    <div class="mb-3">
                      <label class="form-label">Rating</label>
                      <div class="stars">
                        <% for(let i = 1; i <= 5; i++) { %>
                          <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" required>
                          <label for="star<%= i %>">★</label>
                        <% } %>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="comment" class="form-label">Your Review</label>
                      <textarea 
                        name="review[comment]" 
                        class="form-control" 
                        rows="3" 
                        required
                        placeholder="Share your experience..."
                      ></textarea>
                    </div>
                    <button class="btn btn-success">Submit Review</button>
                  </form>
                </div>
              </div>
            <% } %>

            <!-- Display Reviews -->
            <div class="row">
              <% if(listing.reviews && listing.reviews.length > 0) { %>
                <% for(let review of listing.reviews) { %>
                  <div class="col-md-6 mb-3">
                    <div class="card h-100 review-card">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div class="stars-display">
                            <% for(let i = 1; i <= 5; i++) { %>
                              <span class="star <%= i <= review.rating ? 'filled' : '' %>">★</span>
                            <% } %>
                          </div>
                          <small class="text-muted">
                            <%= review.createdAt.toLocaleDateString("en-US", { 
                              year: 'numeric', 
                              month: 'short', 
                              day: 'numeric' 
                            }) %>
                          </small>
                        </div>
                        
                        <p class="card-text review-text"><%= review.comment %></p>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                          <div class="reviewer-info">
                            <i class="fas fa-user-circle me-1"></i>
                            <span class="text-muted"><%= review.author.username %></span>
                          </div>
                          
                          <% if(currentUser && (currentUser.isAdmin || review.author.equals(currentUser._id))) { %>
                            <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
                                  method="POST" 
                                  class="d-inline">
                              <button class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash"></i>
                              </button>
                            </form>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% } %>
              <% } else { %>
                <div class="col-12">
                  <div class="card">
                    <div class="card-body text-center text-muted">
                      <i class="fas fa-comment-slash fa-2x mb-3"></i>
                      <p class="mb-0">No reviews yet. Be the first to review!</p>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Map Card -->
    <div class="col-lg-4">
      <div class="card map-card">
        <div class="card-body p-0">
          <!-- Map Container -->
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="mt-4">
    <a href="/listings" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to all listings
    </a>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Book <%= listing.title %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="bookingForm">
          <div class="mb-3">
            <label class="form-label">Check-in Date</label>
            <input type="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Check-out Date</label>
            <input type="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Number of Guests</label>
            <select class="form-select">
              <% for(let i = 1; i <= listing.capacity; i++) { %>
                <option value="<%= i %>"><%= i %></option>
              <% } %>
            </select>
          </div>
          <div class="col-12 mb-3">
            <div class="card bg-light">
              <div class="card-body">
                <h5>Price Details</h5>
                <div id="priceBreakdown">
                  <!-- Will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success">Confirm Booking</button>
      </div>
    </div>
  </div>
</div>

<style>
  .show-img {
    height: 400px;
    object-fit: cover;
    border-radius: 15px 15px 0 0;
  }

  .listing-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .map-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 20px;
    overflow: hidden;
  }

  .price {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2ecc71;
  }

  .category-badge {
    background: rgba(46, 204, 113, 0.9);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
  }

  .features i {
    margin-right: 8px;
    width: 20px;
  }

  .btn-success {
    background: #2ecc71;
    border: none;
    padding: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background: #27ae60;
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .show-img {
      height: 300px;
    }

    .map-card {
      position: static;
      margin-top: 20px;
    }

    #map {
      height: 300px;
    }
  }

  .mapboxgl-popup-content {
    padding: 15px;
    border-radius: 10px;
  }

  .mapboxgl-popup-content h6 {
    margin: 0 0 5px 0;
    color: #2d3436;
  }

  .mapboxgl-popup-content p {
    margin: 0;
    color: #636e72;
  }

  #map {
    width: 100%;
    height: 500px;
    border-radius: 15px;
  }

  .admin-controls {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
  }

  .admin-controls .btn {
    padding: 8px 16px;
  }

  .admin-controls .btn i {
    margin-right: 5px;
  }

  .features .col-6 {
    padding: 10px;
    font-size: 0.95rem;
    color: #2d3436;
  }

  .features .col-6:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
  }

  .review-card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
  }

  .review-card:hover {
    transform: translateY(-5px);
  }

  .stars {
    display: inline-flex;
    flex-direction: row-reverse;
    gap: 0.25rem;
  }

  .stars input {
    display: none;
  }

  .stars label {
    font-size: 1.5rem;
    color: #e4e5e9;
    cursor: pointer;
    transition: color 0.2s;
  }

  .stars label:hover,
  .stars label:hover ~ label,
  .stars input:checked ~ label {
    color: #ffd700;
  }

  .stars-display {
    display: inline-flex;
  }

  .stars-display .star {
    font-size: 1rem;
    color: #e4e5e9;
  }

  .stars-display .star.filled {
    color: #ffd700;
  }

  .review-text {
    color: #4a5568;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .reviewer-info {
    font-size: 0.9rem;
  }

  .btn-outline-danger {
    border-radius: 50%;
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
  }

  /* Add Review Form Styling */
  .card-title {
    color: #2d3748;
    font-weight: 600;
  }

  textarea.form-control {
    border: 1px solid #e2e8f0;
    resize: none;
  }

  textarea.form-control:focus {
    border-color: #4a5568;
    box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.2);
  }

  .btn-success {
    background-color: #2ecc71;
    border: none;
    padding: 0.5rem 1.5rem;
  }

  .btn-success:hover {
    background-color: #27ae60;
  }

  .user-controls, .guest-controls {
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
  }

  .alert {
    z-index: 1000;
  }

  .price-details {
    font-size: 0.95rem;
  }

  .price-details hr {
    margin: 0.75rem 0;
  }

  .price-details .fw-bold {
    font-size: 1.1rem;
    color: #28a745;
  }

  #priceBreakdown {
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .input-group-text {
    background-color: #e9ecef;
    color: #6c757d;
  }

  .form-text {
    color: #6c757d;
    font-size: 0.875rem;
  }

  .alert {
    margin-bottom: 0;
  }

  .price-details {
    font-size: 0.95rem;
  }

  .price-details .d-flex {
    margin-bottom: 0.5rem;
  }

  .price-details hr {
    margin: 0.75rem 0;
  }

  .price-details .fw-bold {
    color: #28a745;
    font-size: 1.1rem;
  }
</style>

<script>
  // Check if listing has geometry coordinates, otherwise use default
  const defaultCoordinates = [77.2090, 28.6139]; // Default to Delhi coordinates
  const listingCoordinates = '<%= listing.geometry?.coordinates %>' || null;
  const coordinates = listingCoordinates ? listingCoordinates.split(',').map(Number) : defaultCoordinates;

  // Initialize the map
  mapboxgl.accessToken = '<%= process.env.MAP_TOKEN %>';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: coordinates,
    zoom: 9
  });

  // Add marker
  const marker = new mapboxgl.Marker({color: '#ff0000'})
    .setLngLat(coordinates)
    .addTo(map);

  // Add navigation controls
  map.addControl(new mapboxgl.NavigationControl());

  // Add popup
  new mapboxgl.Popup({offset: 25})
    .setLngLat(coordinates)
    .setHTML(`
      <h6><%= listing.title %></h6>
      <p><%= listing.location %>, <%= listing.country %></p>
    `)
    .addTo(map);

  // Ensure the map resizes properly
  map.on('load', function() {
    map.resize();
  });
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const basePrice = <%= listing.price %>;
const maxGuests = <%= listing.capacity %>;
let totalAmount = 0;

function calculatePrice() {
  const checkIn = new Date(document.getElementById('checkIn').value);
  const checkOut = new Date(document.getElementById('checkOut').value);
  const guests = parseInt(document.getElementById('guests').value) || 1;
  const bookNowBtn = document.getElementById('bookNowBtn');

  // Validate guests number
  if (guests > maxGuests) {
    document.getElementById('priceBreakdown').innerHTML = `
      <div class="alert alert-danger">
        Maximum ${maxGuests} guests allowed for this property
      </div>
    `;
    bookNowBtn.disabled = true;
    return;
  }

  if (checkIn && checkOut && checkIn < checkOut) {
    const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
    totalAmount = basePrice * days * guests;

    document.getElementById('priceBreakdown').innerHTML = `
      <div class="price-details">
        <div class="d-flex justify-content-between mb-2">
          <span>Base price per night</span>
          <span>₹${basePrice}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Number of nights</span>
          <span>${days} nights</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Number of guests</span>
          <span>${guests} of ${maxGuests} max</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Total (₹${basePrice} × ${days} nights × ${guests} guests)</span>
          <span>₹${totalAmount}</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold">
          <span>Final Amount</span>
          <span>₹${totalAmount}</span>
        </div>
      </div>
    `;
    bookNowBtn.disabled = false;
  } else {
    document.getElementById('priceBreakdown').innerHTML = `
      <div class="alert alert-info">
        Please select valid dates to see price details
      </div>
    `;
    bookNowBtn.disabled = true;
  }
}

// Add event listener for guests input
document.getElementById('guests')?.addEventListener('input', function() {
  if (this.value > maxGuests) {
    this.value = maxGuests;
    alert(`Maximum ${maxGuests} guests allowed for this property`);
  }
  if (this.value < 1) {
    this.value = 1;
  }
  calculatePrice();
});

// Keep your existing date input initialization and other event listeners

// Update the Razorpay options to include guest capacity info
document.getElementById('bookingForm')?.addEventListener('submit', function(e) {
  e.preventDefault();

  const guests = parseInt(document.getElementById('guests').value);
  if (guests > maxGuests) {
    alert(`Cannot book for more than ${maxGuests} guests`);
    return;
  }

  const options = {
    key: "<%= process.env.RAZORPAY_KEY_ID %>",
    amount: totalAmount * 100,
    currency: "INR",
    name: "<%= listing.title %>",
    description: `Booking for ${guests} guests (Max capacity: ${maxGuests})`,
    prefill: {
      name: "<%= currentUser ? currentUser.username : '' %>",
      email: "<%= currentUser ? currentUser.email : '' %>",
      contact: "9999999999"
    },
    theme: {
      color: "#3399cc"
    },
    handler: function(response) {
      createBooking(response.razorpay_payment_id);
    }
  };

  try {
    const rzp = new Razorpay(options);
    rzp.on('payment.failed', function(response) {
      alert('Payment failed! ' + response.error.description);
    });
    rzp.open();
  } catch (error) {
    console.error('Razorpay Error:', error);
    alert('Payment initialization failed. Please try again.');
  }
});

// Update createBooking function to include capacity check
function createBooking(paymentId) {
  const guests = parseInt(document.getElementById('guests').value);
  
  if (guests > maxGuests) {
    alert(`Cannot book for more than ${maxGuests} guests`);
    return;
  }

  const bookingData = {
    listingId: '<%= listing._id %>',
    checkIn: document.getElementById('checkIn').value,
    checkOut: document.getElementById('checkOut').value,
    guests: guests,
    totalAmount: totalAmount,
    paymentId: paymentId
  };

  fetch('/bookings/create', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(bookingData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Booking successful! Your booking ID is: ' + data.booking.id);
      window.location.href = '/listings';
    } else {
      alert('Booking failed! Please try again.');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Booking failed! Please try again.');
  });
}
</script>

<% layout("layouts/boilerplate") %>
